## <u>StreamStonks</u>: 
An end-to-end MLOps platform for real-time stock price prediction.  
Built with microservices architecture using Kafka, PostgreSQL, CatBoost, and Streamlit.  
Features automated data ingestion, scheduled model retraining, and system health monitoring via Grafana.  

Ð¦ÐµÐ½Ñ‹ Ð°ÐºÑ†Ð¸Ð¹ Ð²Ñ‹Ð³Ñ€ÑƒÐ¶Ð°ÑŽÑ‚ÑÑ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ [T-Invest API](https://www.tinkoff.ru/invest/).

## âœï¸ Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°

```
.
â”œâ”€â”€ docker-compose.yml      # Ð˜Ð½Ñ„Ñ€Ð°ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° (Kafka, ZK, ClickHouse, AKHQ)
â”œâ”€â”€ requirements.txt        # Ð‘Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ¸ Ð´Ð»Ñ Python
â”œâ”€â”€ producer.py             # ETL cÐºÑ€Ð¸Ð¿Ñ‚ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…
â”œâ”€â”€ sql/
â”‚   â”œâ”€â”€ create_tables.sql   # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ‚Ð°Ð±Ð»Ð¸Ñ† Ð² Clickhouse, Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÑŽÑ‰Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· Ñ‚Ð¾Ð¿Ð¸ÐºÐ° (ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ)
â”‚   â””â”€â”€ analysis.sql        # ÐÐ½Ð°Ð»Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ
â”œâ”€â”€ README.md               # Ð’Ñ‹ Ñ‚ÑƒÑ‚
â””â”€â”€ data/                   # Ð—Ð´ÐµÑÑŒ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð»ÐµÐ¶Ð°Ñ‚ÑŒ Ñ„Ð°Ð¹Ð» Ñ Ð»ÑŽÐ±Ñ‹Ð¼ Ð¸Ð¼ÐµÐ½ÐµÐ¼, Ð½Ð¾ Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð¸ÐµÐ¼ .csv
    â””â”€â”€ test.csv           
```
## ðŸ”Œ Ð—Ð°Ð½ÑÑ‚Ñ‹Ðµ Ð¿Ð¾Ñ€Ñ‚Ñ‹

Ð Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚Ð°Ñ Ð¸Ð½Ñ„Ñ€Ð°ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ Ð¿Ð¾Ñ€Ñ‚Ñ‹:

| Ð¡ÐµÑ€Ð²Ð¸Ñ | ÐŸÐ¾Ñ€Ñ‚ | ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ |
| :--- | :--- | :--- |
| **AKHQ** | `8080` | Ð’ÐµÐ±-Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ Ð´Ð»Ñ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð° Ñ‚Ð¾Ð¿Ð¸ÐºÐ¾Ð² Ð¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Kafka. Ð”Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð² Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ðµ: http://localhost:8080 |
| **ClickHouse (HTTP)** | `8123` | HTTP API. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð´Ð»Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ SQL-Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ñ‡ÐµÑ€ÐµÐ· `curl` Ð¸Ð»Ð¸ HTTP-ÐºÐ»Ð¸ÐµÐ½Ñ‚Ñ‹. |
| **ClickHouse (Native)**| `9000` | TCP Ð¿Ð¾Ñ€Ñ‚ (Native Protocol). Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð´Ð»Ñ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ñ‡ÐµÑ€ÐµÐ· IDE (DBeaver, DataGrip) Ð¸Ð»Ð¸ `clickhouse-client`. |
| **Kafka** | `9092` | Ð‘Ñ€Ð¾ÐºÐµÑ€ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹. Ð¡ÑŽÐ´Ð° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÑ‚ÑÑ Python-ÑÐºÑ€Ð¸Ð¿Ñ‚ (`producer.py`) Ð´Ð»Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…. |
| **Zookeeper** | `2181` | Ð¡Ð»ÑƒÐ¶ÐµÐ±Ð½Ñ‹Ð¹ Ð¿Ð¾Ñ€Ñ‚ Ð´Ð»Ñ ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ†Ð¸Ð¸ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ ÐºÐ»Ð°ÑÑ‚ÐµÑ€Ð° Kafka. |

## Ð§Ñ‚Ð¾ Ð´ÐµÐ»Ð°ÐµÑ‚ ÑÐµÑ€Ð²Ð¸Ñ
1. ÐŸÑ€ÐµÐ´Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· csv Ñ„Ð°Ð¹Ð»Ð° Ð² Ñ‚Ð¾Ð¿Ð¸Ðº Kafka
2. Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÑ‚ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ c Ð¾Ð¿Ñ‚Ð¸Ð¼Ð·Ð°Ñ†Ð¸ÐµÐ¹ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð² Clickhouse, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ, Ð² ÑÐ²Ð¾ÑŽ Ð¾Ñ‡ÐµÑ€ÐµÐ´ÑŒ, Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÑŽÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· Ñ‚Ð¾Ð¿Ð¸ÐºÐ° Kafka
3. Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÑ‚ sql Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸ Ð½Ð°Ð¸Ð±Ð¾Ð»ÑŒÑˆÐµÐ¹ Ñ‚Ñ€Ð°Ð½Ð·Ð°ÐºÑ†Ð¸Ð¸ Ð¿Ð¾ ÐºÐ°Ð¶Ð´Ð¾Ð¼Ñƒ ÑˆÑ‚Ð°Ñ‚Ñƒ (Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ð¹ sql Ð·Ð°Ð¿Ñ€Ð¾Ñ)
4. Ð’Ñ‹Ð²Ð¾Ð´Ð¸Ñ‚ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð¸Ñ€ÑƒÑŽÑ‰Ð¸Ð¹ Ñ„Ð°Ð¹Ð» csv

## ðŸ›  ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ Ñ…Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ð°

Ð”Ð»Ñ Ð¾Ð±ÐµÑÐ¿ÐµÑ‡ÐµÐ½Ð¸Ñ Ð²Ñ‹ÑÐ¾ÐºÐ¾Ð¹ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸ Ñ†ÐµÐ»ÐµÐ²Ð¾Ð³Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° (`GROUP BY us_state`) Ð¸ Ð¼Ð¸Ð½Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ñ€Ð°Ð·Ð¼ÐµÑ€Ð° Ñ…Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ð° Ð±Ñ‹Ð»Ð¸ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ñ‹ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð² DDL Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ ClickHouse:

1.  **Ð¡Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²ÐºÐ° (ORDER BY):**
    Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½ ÐºÐ»ÑŽÑ‡ `(us_state, cat_id, transaction_time)`. ÐŸÐ¾ÑÐºÐ¾Ð»ÑŒÐºÑƒ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð½Ð° Ð´Ð¸ÑÐºÐµ Ñ„Ð¸Ð·Ð¸Ñ‡ÐµÑÐºÐ¸ ÑƒÐ¿Ð¾Ñ€ÑÐ´Ð¾Ñ‡ÐµÐ½Ñ‹ Ð¿Ð¾ ÑˆÑ‚Ð°Ñ‚Ñƒ (`us_state`), Ð´Ð²Ð¸Ð¶Ð¾Ðº ÑÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾ÑÐ»ÐµÐ´Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾, Ñ‡Ñ‚Ð¾ Ð¼Ð½Ð¾Ð³Ð¾ÐºÑ€Ð°Ñ‚Ð½Ð¾ ÑƒÑÐºÐ¾Ñ€ÑÐµÑ‚ Ð°Ð³Ñ€ÐµÐ³Ð°Ñ†Ð¸ÑŽ Ð¿Ð¾ ÑˆÑ‚Ð°Ñ‚Ð°Ð¼.

2.  **LowCardinality(String):**
    ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½ Ð´Ð»Ñ ÐºÐ¾Ð»Ð¾Ð½Ð¾Ðº Ñ Ð½Ð¸Ð·ÐºÐ¾Ð¹ Ð²Ð°Ñ€Ð¸Ð°Ñ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒÑŽ (`us_state`, `cat_id`, `gender`). ClickHouse Ð·Ð°Ð¼ÐµÐ½ÑÐµÑ‚ ÑÑ‚Ñ€Ð¾ÐºÐ¸ Ð½Ð° Ñ‡Ð¸ÑÐ»Ð¾Ð²Ñ‹Ðµ ÑÐ»Ð¾Ð²Ð°Ñ€Ð¸, Ñ‡Ñ‚Ð¾ ÑƒÐ¼ÐµÐ½ÑŒÑˆÐ°ÐµÑ‚ Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð»ÐµÐ½Ð¸Ðµ RAM Ð¸ ÑƒÑÐºÐ¾Ñ€ÑÐµÑ‚ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸ ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ñ Ð¸ Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ¸.

3.  **ÐšÐ¾Ð´ÐµÐºÐ¸ ÑÐ¶Ð°Ñ‚Ð¸Ñ (Codecs):**
    * `CODEC(DoubleDelta, ZSTD(1))` Ð´Ð»Ñ `transaction_time`: Ð­Ñ„Ñ„ÐµÐºÑ‚Ð¸Ð²Ð½Ð¾Ðµ Ð´ÐµÐ»ÑŒÑ‚Ð°-ÑÐ¶Ð°Ñ‚Ð¸Ðµ Ð´Ð»Ñ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ñ€ÑÐ´Ð¾Ð².
    * `CODEC(ZSTD(1))` Ð´Ð»Ñ ÑÑ‚Ñ€Ð¾Ðº: ÐžÐ±ÐµÑÐ¿ÐµÑ‡Ð¸Ð²Ð°ÐµÑ‚ Ð»ÑƒÑ‡ÑˆÐ¸Ð¹ ÐºÐ¾ÑÑ„Ñ„Ð¸Ñ†Ð¸ÐµÐ½Ñ‚ ÑÐ¶Ð°Ñ‚Ð¸Ñ Ð¿Ð¾ ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸ÑŽ ÑÐ¾ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ð¼ LZ4, ÑÐ½Ð¸Ð¶Ð°Ñ Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÑƒ Ð½Ð° Ð´Ð¸ÑÐºÐ¾Ð²ÑƒÑŽ Ð¿Ð¾Ð´ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ (I/O).

## ðŸš€ Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ ÑÑ‚Ð°Ñ€Ñ‚

### Ð¢Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ
- Docker 20.10+
- Docker Compose 2.0+

### Ð—Ð°Ð¿ÑƒÑÐº

Ð¡ÐºÐ°Ñ‡Ð°Ð¹Ñ‚Ðµ Ñ„Ð°Ð¹Ð» `train.csv` Ð¸Ð»Ð¸ `test.csv` (Ð»ÑƒÑ‡ÑˆÐµ `test.csv`, Ñ Ð½Ð¸Ð¼ Ð±ÑƒÐ´ÐµÑ‚ Ð±Ñ‹ÑÑ‚Ñ€ÐµÐµ) Ð¸Ð· ÑÐ¾Ñ€ÐµÐ²Ð½Ð¾Ð²Ð°Ð½Ð¸Ñ https://www.kaggle.com/competitions/teta-ml-1-2025 Ð¸ Ñ€Ð°Ð·Ð¼ÐµÑÑ‚Ð¸Ñ‚Ðµ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ `/data`
```bash
git clone https://github.com/uroplatus666/mts25_mlops_hse_3part.git
cd mts25_mlops_hse_3part

# Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¸ Ð·Ð°Ð¿ÑƒÑÐº Ð²ÑÐµÑ… ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
docker compose up -d
```

### Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ Ð² Clickhouse
```bash
cat sql/create_tables.sql | docker exec -i clickhouse clickhouse-client -u click --password click -n

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ ÑÐ¾Ð·Ð´Ð°Ð»Ð¸ÑÑŒ
curl 'http://click:click@localhost:8123/?query=SHOW%20TABLES'
```
### Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½ÑƒÑŽ ÑÑ€ÐµÐ´Ñƒ Ð¸ ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
```bash
python3 -m venv .venv 
source .venv/bin/activate 
pip install -r requirements.txt
```
### ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð² Kafka
```bash
python producer.py
```
### ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð´Ð¾ÑˆÐ»Ð¸ Ð»Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð¾ Clickhouse
```bash
curl 'http://click:click@localhost:8123/?query=SELECT+count()+FROM+transactions'
```
### Ð”ÐµÐ»Ð°ÐµÐ¼ Ð½ÑƒÐ¶Ð½Ñ‹Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ, ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð² result.csv Ð¸ Ð²Ñ‹Ð²Ð¾Ð´Ð¸Ð¼ Ð¿ÐµÑ€Ð²Ñ‹Ðµ 5 ÑÑ‚Ñ€Ð¾Ðº Ñ„Ð°Ð¹Ð»Ð° Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸
```bash
cat sql/analysis.sql | curl 'http://click:click@localhost:8123/' --data-binary @- > result.csv
head -n 5 result.csv
```
